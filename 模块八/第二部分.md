# ç¬¬äºŒéƒ¨åˆ†

é™¤äº†å°† httpServer åº”ç”¨ä¼˜é›…åœ°è¿è¡Œåœ¨ Kubernetes ä¹‹ä¸Šï¼Œæˆ‘ä»¬è¿˜åº”è¯¥è€ƒè™‘å¦‚ä½•å°†æœåŠ¡å‘å¸ƒç»™å¯¹å†…å’Œå¯¹å¤–çš„è°ƒç”¨æ–¹ã€‚
æ¥å°è¯•ç”¨ Serviceã€Ingress å°†ä½ çš„æœåŠ¡å‘å¸ƒç»™é›†ç¾¤å¤–éƒ¨çš„è°ƒç”¨æ–¹å§ã€‚
åœ¨ç¬¬ä¸€éƒ¨åˆ†çš„åŸºç¡€ä¸Šæä¾›æ›´åŠ å®Œå¤‡çš„éƒ¨ç½² specï¼ŒåŒ…æ‹¬ï¼ˆä¸é™äºï¼‰ï¼š

- Service
- Ingress

å¯ä»¥è€ƒè™‘çš„ç»†èŠ‚

- å¦‚ä½•ç¡®ä¿æ•´ä¸ªåº”ç”¨çš„é«˜å¯ç”¨ã€‚
- å¦‚ä½•é€šè¿‡è¯ä¹¦ä¿è¯ httpServer çš„é€šè®¯å®‰å…¨ã€‚

## éœ€æ±‚åˆ†æ

* é€šè¿‡ Pod å¤šå‰¯æœ¬ + HPA çš„æ–¹å¼å®ç°åº”ç”¨çš„é«˜å¯ç”¨

  ````bash
  ğŸ§ kubectl get deploy httpserver
  NAME         READY   UP-TO-DATE   AVAILABLE   AGE
  httpserver   2/2     2            2           6d
  # å½“å‰ä¸º 2 å‰¯æœ¬
  ````

* åˆ›å»º Ingress https æ¥ä¿è¯ httpServer çš„é€šè®¯å®‰å…¨

## åŠŸèƒ½å®ç°

### HPA

å¦‚ä¸‹ä¸ºåŸºäº CPU ä½¿ç”¨ç‡æŒ‡æ ‡åˆ›å»ºçš„ Pod è‡ªåŠ¨æ‰©ç¼©å®¹ç­–ç•¥ï¼š

````bash
kubectl autoscale deployment httpserver --cpu-percent=60 --min=1 --max=10
````

### Service å‘å¸ƒåº”ç”¨

Service é‡‡ç”¨ NodePort æ¨¡å¼å¯¹å¤–å‘å¸ƒåº”ç”¨ï¼Œç”¨æˆ·åœ¨é›†ç¾¤å¤–éƒ¨å¯é€šè¿‡ `NodeIP:NodePort` çš„å½¢å¼æ¥è®¿é—®é›†ç¾¤å†…éƒ¨çš„åº”ç”¨ã€‚

**æ•°æ®åŒ…èµ°å‘**

* Client â†’ NodeIP:NodePort â†’ ServiceIP:ServicePort â†’ PodIP:ContainerPort

**ä¸è¶³ä¹‹å¤„**

* æœåŠ¡ä¸€æ—¦å¤šèµ·æ¥ï¼Œç«¯å£å¼€é”€å¤§ï¼Œç®¡ç†å’Œç»´æŠ¤æˆæœ¬é«˜ã€‚
* IP å’Œç«¯å£æš´éœ²åœ¨å¤–ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£ã€‚

``````yaml
# httpserver-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: httpserver
  namespace: default
  labels:
    app: httpserver
spec:
  type: NodePort
  ports:
    - name: http
      targetPort: 80
      port: 80
  selector:
    app: httpserver
``````

````bash
### åˆ›å»º Service
kubectl apply -f httpserver-svc.yaml

### æŸ¥çœ‹ Service
ğŸ§ kubectl get svc httpserver
NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
httpserver   NodePort   10.111.205.83   <none>        80:30959/TCP   61s

### è®¿é—®åº”ç”¨
ğŸ§ curl node31:30959 # node31 ä¸º k8s ç®¡ç†èŠ‚ç‚¹çš„ä¸»æœºå
Hello World
````

### Ingress å‘å¸ƒåº”ç”¨

Ingress å³ä¸€ç»„åŸºäº DNS åç§°æˆ– URL è·¯å¾„å°†è¯·æ±‚è½¬å‘åˆ°æŒ‡å®šçš„ Service èµ„æºçš„è§„åˆ™ï¼Œç”¨äºå°†é›†ç¾¤å¤–éƒ¨çš„è¯·æ±‚æµé‡è½¬å‘åˆ°é›†ç¾¤å†…éƒ¨å®ŒæˆæœåŠ¡çš„å‘å¸ƒã€‚

**æ•°æ®åŒ…èµ°å‘**

* Client â†’ Ingress Controller â†’ Pod

**å‡†å¤‡è¯ä¹¦**

`````bash
mkdir -p https_tls && cd https_tls

### ç”Ÿæˆç§é’¥
openssl genrsa -out tls.key 2048

### ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -new -x509 -key tls.key -out tls.crt -subj /C=CN/ST=Jiangsu/L=Nanjing/O=HttpServer/CN=httpserver.lucky.com
`````

**ç”Ÿæˆ secret**

`````bash
### åˆ›å»º Secret
kubectl create secret tls httpserver-ingress-secret --cert=tls.crt --key=tls.key

### æŸ¥çœ‹ Secret
ğŸ§ kubectl get secret httpserver-ingress-secret
NAME                        TYPE                DATA   AGE
httpserver-ingress-secret   kubernetes.io/tls   2      4s
`````

**åˆ›å»º Ingress**

`````yaml
# httpserver-ingress-https.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: httpserver-tls
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  tls:
    - hosts:
        - httpserver.lucky.com
      secretName: httpserver-ingress-secret
  rules:
    - host: httpserver.lucky.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: httpserver
                port:
                  number: 80
`````

````bash
### åˆ›å»º Ingress
kubectl apply -f httpserver-ingress-https.yaml

### æŸ¥çœ‹ Ingress
ğŸ§ kubectl get ingress httpserver-tls
NAME             CLASS    HOSTS                  ADDRESS   PORTS     AGE
httpserver-tls   <none>   httpserver.lucky.com             80, 443   12s

### ä¿®æ”¹æœ¬åœ° hosts æ–‡ä»¶ï¼Œè¿½åŠ å†™å…¥å¦‚ä¸‹å†…å®¹
ğŸ§ vim /etc/hosts
192.168.95.32 httpserver.lucky.com # 192.168.95.32 ä¸º Ingress Controller éƒ¨ç½²èŠ‚ç‚¹

### è®¿é—®åº”ç”¨
ğŸ§ curl https://httpserver.lucky.com -k
Hello World
````

