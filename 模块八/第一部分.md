# ç¬¬ä¸€éƒ¨åˆ†

ç¼–å†™ Kubernetes éƒ¨ç½²è„šæœ¬å°† httpserver éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ï¼Œä»¥ä¸‹æ˜¯ä½ å¯ä»¥æ€è€ƒçš„ç»´åº¦ã€‚

- ä¼˜é›…å¯åŠ¨
- ä¼˜é›…ç»ˆæ­¢
- èµ„æºéœ€æ±‚å’Œ QoS ä¿è¯
- æ¢æ´»
- æ—¥å¸¸è¿ç»´éœ€æ±‚ï¼Œæ—¥å¿—ç­‰çº§
- é…ç½®å’Œä»£ç åˆ†ç¦»

## éœ€æ±‚åˆ†æ

### ä¼˜é›…å¯åŠ¨

å®¹å™¨å†…çš„æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œå¹¶ä¸æ„å‘³ç€å®ƒå°±å¯ä»¥æ¥æ”¶å¹¶å¤„ç†å¤–éƒ¨è¯·æ±‚ã€‚

ä¸ºä¿è¯åº”ç”¨ä¸ä¼šä¸å¯ç”¨åœ°æä¾›ç»™ç”¨æˆ·ï¼Œéœ€è¦é…ç½®å°±ç»ªæ¢æµ‹ï¼š

````yaml
readinessProbe:
  httpGet: # å‘ http://$podIP:$httpserver/healthz å‘é€ GET è¯·æ±‚æ¥æ‰§è¡Œæ¢æµ‹
    path: /healthz
    port: httpserver
    scheme: HTTP
  periodSeconds: 3       # æ¯ 3 ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹
  initialDelaySeconds: 3 # åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰ç­‰å¾… 3 ç§’
  successThreshold: 1    # æ¢æµ‹æˆåŠŸ 1 æ¬¡å³è¡¨ç¤ºå°±ç»ª
  failureThreshold: 3    # æ¢æµ‹å¤±è´¥ 3 æ¬¡å³è¡¨ç¤ºæœªå°±ç»ª
````

### ä¼˜é›…ç»ˆæ­¢

åŸºäº preStop hook å®ç°ä¼˜é›…ç»ˆæ­¢ï¼š

````yaml
# pod.spec.containers.lifecycle
lifecycle:
  preStop:
    exec:
      command: ["/bin/sh -c 'kill -SIGTERM -1'"]
````

æ”¹å†™ç¨‹åºï¼Œä»¥æ”¯æŒä¼˜é›…ç»ˆæ­¢ï¼š

````go
func main() {
	flag.Parse()
	http.HandleFunc("/", rootHandler)
	http.HandleFunc("/healthz", healthz)
	
    log.Println("Starting http server...")
    server := http.Server{Addr: ":80"}
	go func() {
		if err := server.ListenAndServe(); err != nil {
			log.Fatal(err)
		}
	}()

	c := make(chan os.Signal, 1)
	signal.Notify(c, syscall.SIGTERM)
	s := <-c
	log.Printf("æ¥æ”¶ä¿¡å·: %s\n", s)
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()
	if err := server.Shutdown(ctx); err != nil {
		log.Println("server shutdown failed")
	}
	log.Println("server exit")
}
````

åŸºäº Dockerfile æ„å»ºé•œåƒ `enjoylinux/httpserver:1.1`ï¼š

````dockerfile
FROM golang:1.17 AS build
WORKDIR /httpserver/
COPY . .
ENV CGO_ENABLED=0 \
    GO111MODULE=on \
    GOPROXY=https://goproxy.cn,direct
RUN GOOS=linux go build -installsuffix cgo -o httpserver main.go

FROM alpine:latest
COPY --from=build /httpserver/httpserver /httpserver/httpserver
EXPOSE 80
WORKDIR /httpserver/
ENTRYPOINT ["./httpserver"]
````

å°†é•œåƒæ¨é€è‡³ä¸ªäºº dockerhub è´¦æˆ·ã€‚

### èµ„æºéœ€æ±‚å’Œ QoS ä¿è¯

å°† QoS ç±»è®¾ç½®ä¸º Burstableï¼Œä»¥æé«˜èŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡ã€‚å¹¶ç‰¹åˆ«é’ˆå¯¹å†…å­˜è¿™ç±»ä¸å¯å‹ç¼©èµ„æºåšé™é¢ã€‚

````yaml
resources:
  limits:
    memory: "200Mi"
  requests:
    memory: "100Mi"
    cpu: 0.5
````

### æ¢æ´»

ä¸ºé˜²æ­¢ç¨‹åºå‡æ­»ï¼Œéœ€è¦é…ç½®å­˜æ´»æ¢æµ‹ï¼š

````yaml
livenessProbe:
  httpGet: # å‘ http://$podIP:$httpserver/healthz å‘é€ GET è¯·æ±‚æ¥æ‰§è¡Œæ¢æµ‹
    path: /healthz
    port: httpserver
    scheme: HTTP
  periodSeconds: 3       # æ¯ 3 ç§’æ‰§è¡Œä¸€æ¬¡æ¢æµ‹
  initialDelaySeconds: 3 # åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰ç­‰å¾… 3 ç§’
  successThreshold: 1    # æ¢æµ‹æˆåŠŸ 1 æ¬¡å³è¡¨ç¤ºæ­£å¸¸å­˜æ´»
  failureThreshold: 3    # æ¢æµ‹å¤±è´¥ 3 æ¬¡å³è¡¨ç¤ºç¨‹åºå‡æ­»ï¼Œkubelet ä¼šæ€æ‰æ­¤å®¹å™¨
````

### é…ç½®å’Œä»£ç åˆ†ç¦»

åŸºäº ConfigMap å®ç°é…ç½®ç®¡ç†ï¼š

````yaml
kind: ConfigMap
apiVersion: v1
metadata:
  name: httpserver
data:
  VERSION: v1.0.0
````

Pod æŒ‚è½½ ConfigMapï¼š

 ```yaml
 # pod.spec.containers.env
 env:
   - valueFrom:
       configMapKeyRef:
         name: VERSION
         key: VERSION
 ```

### æ—¥å¸¸è¿ç»´éœ€æ±‚ï¼Œæ—¥å¿—ç­‰çº§

**æ—¥å¿—ç­‰çº§**

* åˆ›å»º ConfigMap èµ„æºå¯¹è±¡ï¼Œå­˜å‚¨æ•°æ® `LOGLEVEL: INFO`ï¼›

* åˆ›å»º Pod æ—¶ï¼Œä½¿ç”¨ `env.valueFrom.configMapKeyRef`ï¼ŒåŸºäºä¸Šé¢çš„ ConfigMap ç”Ÿæˆç¯å¢ƒå˜é‡ LOGLEVELï¼›
* httpserver ç¨‹åºè¿è¡Œæ—¶ä½¿ç”¨ `os.Getenv("LOGLEVEL")` è¯»å–ç¯å¢ƒå˜é‡ï¼Œè®¾ç½®æ—¥å¿—ç­‰çº§ã€‚

**æ—¥å¸¸è¿ç»´éœ€æ±‚**

* åŸºäº HPA å®ç° Pod æ°´å¹³æ‰©ç¼©å®¹ï¼›
* è®¾ç½®æ»šåŠ¨æ›´æ–°ç­–ç•¥ã€‚

````yaml
# deploy.spec.strategy
strategy:
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 1
  type: RollingUpdate
````



## åŠŸèƒ½å®ç°

**è·å– ImagePullSecrets**

````bash
ğŸ§ docker login 
Username: enjoylinux
Password: 
Login Succeeded

ğŸ§ cat /root/.docker/config.json | base64 -w0
ewoJImF1dGhzIjogewoJXXXodHRwczovL2luZGV4LmRXXX92MS8iXXB7CgkJCXXXxzYVc1MWVEcEdhR0YzTURBeUXXXRUE9IgoJCX0KCX0KfQ==
````

**åˆ›å»º Secretã€ConfigMapã€Deployment èµ„æºå¯¹è±¡**

````yaml
# httpserver.yaml
apiVersion: v1
kind: Secret
metadata:
  name: dockerhub
type: kubernetes.io/dockercfg
data:
  .dockercfg: ewoJImF1dGhzIjogewoJXXXodHRwczovL2luZGV4LmRXXX92MS8iXXB7CgkJCXXXxzYVc1MWVEcEdhR0YzTURBeUXXXRUE9IgoJCX0KCX0KfQ==
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: httpserver
data:
  VERSION: v1.0.0
  LOGLEVEL: INFO
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: httpserver
  namespace: default
  labels:
    app: httpserver
spec:
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  replicas: 2
  selector:
    matchLabels:
      app: httpserver
  template:
    metadata:
      labels:
        app: httpserver
    spec:
      imagePullSecrets:
        - name: dockerhub
      containers:
        - name: httpserver
          image: enjoylinux/httpserver:1.1
          imagePullPolicy: IfNotPresent
          ports:
            - name: httpserver
              containerPort: 80
              protocol: TCP
          env:
            - name: VERSION
              valueFrom:
                configMapKeyRef:
                  name: httpserver
                  key: VERSION
            - name: LOGLEVEL
              valueFrom:
                configMapKeyRef:
                  name: httpserver
                  key: LOGLEVEL
          resources:
            limits:
              memory: "200Mi"
            requests:
              memory: "100Mi"
              cpu: 0.5
          readinessProbe:
            httpGet:
              path: /healthz
              port: httpserver
              scheme: HTTP
            periodSeconds: 3
            initialDelaySeconds: 3
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /healthz
              port: httpserver
              scheme: HTTP
            periodSeconds: 3
            initialDelaySeconds: 3
            successThreshold: 1
            failureThreshold: 3
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh -c 'kill -SIGTERM -1'"]
````

**æŸ¥çœ‹ç»“æœ**

````bash
ğŸ§ kubectl get po -l app=httpserver -owide
NAME                         READY   STATUS    RESTARTS   AGE   IP              NODE     NOMINATED NODE   READINESS GATE
httpserver-6494789c5-97j2n   1/1     Running   0          32s   10.244.51.210   node32   <none>           <none>
httpserver-6494789c5-qxxk7   1/1     Running   0          32s   10.244.51.211   node32   <none>           <none>

ğŸ§ curl 10.244.51.210
Hello World
````

